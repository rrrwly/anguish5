<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>defeat</title>

  <!-- Discord / Open Graph (skinny image, gray line text, no blue title) -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="&#8203;"><!-- hide blue title -->
  <meta property="og:description" content="A Silent Throne Drenched in Power" />
  <meta property="og:url" content="https://defeat.rip/" />
  <meta property="og:image" content="https://defeat.rip/assets/sword.png?v=17" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="400" />
  <meta property="og:image:height" content="600" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://defeat.rip/assets/sword.png?v=17" />
  <meta name="theme-color" content="#000000" />

  <!-- Pixel font only for the gate text -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    body{
      margin:0; display:flex; flex-direction:column; justify-content:center; align-items:center;
      height:95vh; background:#fff; color:#000; font-family:Arial, sans-serif;
      animation:fadeIn 2s ease-in; cursor:none; overflow:hidden;
    }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    /* Blur until enter */
    .site{ filter:blur(16px); opacity:.85; transition:filter 1200ms ease, opacity 1200ms ease; pointer-events:none; }
    .site.clear{ filter:blur(0); opacity:1; pointer-events:auto; }

    /* Gate overlay */
    .gate{
      position:fixed; inset:0; background:rgba(255,255,255,.6);
      z-index:100010; display:grid; place-items:center; cursor:none;
      transition:opacity .8s ease, visibility .8s ease; opacity:1; visibility:visible; pointer-events:auto;
    }
    .gate.hidden{ opacity:0; visibility:hidden; pointer-events:none; }
    .gate-button{
      background:none; border:0; padding:0; margin:0;
      font-family:'Press Start 2P', monospace; font-size:14px; letter-spacing:.08em; color:#000; opacity:.9;
      user-select:none; text-align:center; animation:pulse 1.4s infinite;
    }
    .gate-button:focus{ outline:none; }
    @keyframes pulse{0%{opacity:.6}50%{opacity:1}100%{opacity:.6}}

    /* Marquee (init on enter) */
    .marquee-container{
      overflow:hidden; box-sizing:border-box; font-size:14px; white-space:nowrap; text-align:center;
      visibility:hidden; margin-top:4px;
    }
    #track{ display:inline-block; white-space:nowrap; will-change:transform; }

    span{ font-size:14px; text-align:center; margin-top:10px; opacity:.85; }

    /* Music UI */
    audio{ display:none; }
    .music-controls{
      position:fixed; bottom:15px; right:20px; display:flex; align-items:center; gap:8px;
      opacity:0; visibility:hidden; transition:all .5s ease;
      background:rgba(0,0,0,.05); padding:6px 10px; border-radius:8px; border:1px solid rgba(0,0,0,.2);
      z-index:10000; font-size:12px;
    }
    .music-controls.show{ opacity:.9; visibility:visible; }
    #volume-slider{ width:100px; cursor:pointer; accent-color:#000; }
    #song-name{ font-size:12px; opacity:.8; }

    /* Knife + drips */
    :root{ --tip-x:0.1px; --tip-y:10px; --knife-angle:-18deg; }
    .knife{
      position:fixed; width:60px; height:60px; left:0; top:0;
      background-size:contain; background-repeat:no-repeat; background-position:center;
      image-rendering:pixelated; transform-origin:15px 15px; pointer-events:none; z-index:100002;
    }
    .drop{
      position:fixed; width:6px; height:6px; border-radius:50%; background:rgb(223,30,99); pointer-events:none; z-index:9999;
      animation:fall var(--dur) linear forwards; box-shadow:0 0 6px rgba(223,30,99,.4);
    }
    @keyframes fall{0%{opacity:1; transform:translateY(0)}100%{opacity:0; transform:translateY(160px)}}

    img.hero{max-width:70vmin; height:auto}
  </style>
</head>
<body>
  <!-- Knife cursor -->
  <div class="knife" id="knife"></div>

  <!-- Main content (starts blurred) -->
  <div id="site" class="site">
    <img
      id="hero"
      class="hero"
      src="/assets/undefeated.gif"
      alt="undefeated gif"
      onerror="this.onerror=null; this.src='https://cdn.discordapp.com/attachments/1117356079051964446/1424607076667097158/ZBzQzuI.gif';"
    />
    <div>defeat</div>

    <!-- Marquee (one pass; starts after enter) -->
    <div class="marquee-container" id="names">
      <div id="track"><span id="namesText">jord ryan matt saph maly tyler</span></div>
    </div>

    <span>uneasy lies the head that wears the crown</span>
  </div>

  <!-- Audio -->
  <audio id="bg-music" loop playsinline preload="auto">
    <source src="/assets/what-you-had-capo.mp3" type="audio/mpeg">
  </audio>
  <div id="music-controls" class="music-controls">
    <span id="song-name">ðŸŽµ Now Playing: What You Had â€“ Capo</span>
    <span class="volume-label">ðŸ”Š</span>
    <input id="volume-slider" type="range" min="0" max="1" step="0.01" value="1">
  </div>
  <audio id="sfx-stab" preload="auto">
    <source src="/assets/stab.mp3" type="audio/mpeg">
  </audio>

  <!-- Click-to-enter gate -->
  <div id="gate" class="gate" role="button" aria-label="Click to enter">
    <button id="gateBtn" class="gate-button" type="button">CLICK TO ENTER</button>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* Initial state */
    const site = document.getElementById('site');
    const gate = document.getElementById('gate');
    const gateBtn = document.getElementById('gateBtn');
    site.classList.remove('clear');
    gate.classList.remove('hidden');

    /* ===== Music ===== */
    const music = document.getElementById('bg-music');
    const slider = document.getElementById('volume-slider');
    const controls = document.getElementById('music-controls');
    const songName = document.getElementById('song-name');
    const SONG_TITLE = "What You Had â€“ Capo";

    const MUSIC_CANDIDATES = [
      '/assets/what-you-had-capo.mp3',
      '/assets/What-You-Had-Capo.mp3',
      '/assets/What You Had - Capo.mp3',
      '/assets/What%20You%20Had%20-%20Capo.mp3',
      'https://cdn.jsdelivr.net/gh/rrrwly/anguish5@main/assets/what-you-had-capo.mp3'
    ];

    function fadeTo(targetVol = Number(slider.value || 1), ms = 6000){
      let i = 0; const steps = Math.max(1, Math.round(ms/50));
      music.volume = 0;
      const t = setInterval(()=>{ i++; music.volume = Math.min(targetVol, (i/steps)*targetVol); if(i>=steps) clearInterval(t); }, 50);
    }

    // Try fallbacks only if the first play fails
    async function tryFallbackSources(){
      for(const u of MUSIC_CANDIDATES){
        if (music.currentSrc && music.currentSrc.endsWith(u)) continue;
        music.src = u;
        try { await music.play(); return true; } catch(e) {}
      }
      return false;
    }

    // Start music immediately in the gesture call stack
    function startMusicInGesture(){
      try{
        music.muted = false;
        const p = music.play();
        if (p && typeof p.then === 'function'){
          p.then(()=>{
            fadeTo(); controls.classList.add('show'); songName.textContent = "ðŸŽµ Now Playing: " + SONG_TITLE;
          }).catch(async ()=>{
            const ok = await tryFallbackSources();
            if (ok){ fadeTo(); controls.classList.add('show'); songName.textContent = "ðŸŽµ Now Playing: " + SONG_TITLE; }
          });
        }else{
          // older browsers
          fadeTo(); controls.classList.add('show'); songName.textContent = "ðŸŽµ Now Playing: " + SONG_TITLE;
        }
      }catch(e){}
    }

    slider.addEventListener('input', ()=>{ music.volume = Number(slider.value); });

    /* ===== Knife + drips ===== */
    const knifeEl=document.getElementById('knife');
    const CLEAN_KNIFE_URL="/assets/knife-clean.png";
    const BLOODY_KNIFE_URL="/assets/knife.png";
    knifeEl.style.backgroundImage=`url(${CLEAN_KNIFE_URL})`;
    knifeEl.style.transform='rotate(-18deg)';

    let mx=innerWidth/2, my=innerHeight/2;
    function placeKnife(){ knifeEl.style.left=(mx-30)+'px'; knifeEl.style.top=(my-30)+'px'; }
    placeKnife();
    ['mousemove','pointermove','touchmove'].forEach(evt=>{
      addEventListener(evt, e=>{ const p=e.touches?e.touches[0]:e; mx=p.clientX; my=p.clientY; placeKnife(); }, {passive:true});
    });

    function startDrips(){
      const DRIP_INTERVAL_MS=260, DRIP_JITTER=3;
      setInterval(()=>{
        const tipX=0.1, tipY=10;
        const d=document.createElement('div'); d.className='drop';
        const size=3+Math.random()*3, dur=1.4+Math.random()*2.0;
        d.style.width=d.style.height=size+'px';
        d.style.setProperty('--dur',dur+'s');
        d.style.opacity=0.6+Math.random()*0.35;
        const x=mx+tipX+(Math.random()*DRIP_JITTER-DRIP_JITTER/2);
        const y=my+tipY+(Math.random()*DRIP_JITTER-DRIP_JITTER/2);
        d.style.left=x+'px'; d.style.top=y+'px';
        document.body.appendChild(d);
        setTimeout(()=>d.remove(), dur*1000);
      }, DRIP_INTERVAL_MS);
    }

    const stab=document.getElementById('sfx-stab');
    function playStabAndSwapInGesture(){
      const onPlay=()=>{ knifeEl.style.backgroundImage=`url(${BLOODY_KNIFE_URL})`; startDrips(); stab.removeEventListener('play', onPlay); };
      stab.addEventListener('play', onPlay, {once:true});
      try{
        stab.currentTime=0;
        const p = stab.play();
        if (p && typeof p.catch==='function'){ p.catch(()=>{ onPlay(); }); }
      }catch(e){ onPlay(); }
    }

    /* ===== One-pass marquee (start on enter) ===== */
    function initMarquee(){
      const container = document.getElementById('names');
      const track     = document.getElementById('track');
      const textEl    = document.getElementById('namesText');

      const ghost = textEl.cloneNode(true);
      ghost.style.cssText='position:absolute; visibility:hidden; white-space:nowrap; left:-9999px; top:-9999px;';
      document.body.appendChild(ghost);
      const textW = Math.ceil(ghost.offsetWidth);
      document.body.removeChild(ghost);

      const maxW = Math.floor(window.innerWidth * 0.9);
      const viewportW = Math.min(textW, maxW);

      container.style.width = viewportW + 'px';
      container.style.visibility = 'visible';

      let x = viewportW;           // start off the right edge
      const speed = 60;            // px/sec
      let last = performance.now();

      function step(ts){
        const dt = (ts - last) / 1000; last = ts;
        x -= speed * dt;
        if (x <= 0){
          track.style.transform = 'translateX(0px)'; // stop with names visible
          container.style.width = viewportW + 'px';
          return;
        }
        track.style.transform = `translateX(${x}px)`;
        requestAnimationFrame(step);
      }
      track.style.transform = `translateX(${x}px)`;
      requestAnimationFrame(step);
    }

    /* ===== Enter flow (sync in user-gesture) ===== */
    let entered = false;
    function startExperience(){
      if (entered) return;
      entered = true;

      // 1) Start audio immediately in gesture stack
      startMusicInGesture();

      // 2) Play stab SFX and swap knife immediately
      playStabAndSwapInGesture();

      // 3) Reveal site now (CSS transitions handle blur-out)
      site.classList.add('clear');
      gate.classList.add('hidden');

      // 4) Kick off marquee after layout settles
      requestAnimationFrame(()=> initMarquee());
    }

    // Bind robustly on gate and button (do not preventDefault to keep gesture intact)
    ['pointerdown','click','touchstart','mousedown','mouseup','pointerup','touchend'].forEach(evt=>{
      gate.addEventListener(evt, startExperience, {passive:true});
      gateBtn.addEventListener(evt, startExperience, {passive:true});
    });

    // Safety net: first gesture anywhere on the page (capture)
    const firstGesture = (e) => {
      if (!entered) startExperience();
      // remove after first fire
      ['pointerdown','click','touchstart','mousedown','keydown'].forEach(ev=>{
        document.removeEventListener(ev, firstGesture, true);
      });
    };
    ['pointerdown','click','touchstart','mousedown','keydown'].forEach(ev=>{
      document.addEventListener(ev, firstGesture, true);
    });

    // Keyboard accessibility while gate visible
    document.addEventListener('keydown', (e)=> {
      if ((e.key==='Enter' || e.key===' ') && !entered) startExperience();
    });
  });
  </script>
</body>
</html>
